name: Pack Previews (PR)

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'

jobs:
  pack-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            9.0.x
            6.0.x

      - name: NuGet Cache
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.sln', '**/*.csproj', '**/packages.lock.json') }}

      - name: Restore
        run: dotnet restore

      - name: Set Preview Version
        id: ver
        run: echo "version=0.0.${{ github.run_number }}-preview.${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Pack all packable csproj (preview)
        run: |
          mkdir -p ./nupkgs
          dotnet pack src/ToggleNet.Core/ToggleNet.Core.csproj -c Release -o ./nupkgs /p:Version=${{ steps.ver.outputs.version }} /p:IncludeSymbols=true /p:SymbolPackageFormat=snupkg /p:ContinuousIntegrationBuild=true
          dotnet pack src/ToggleNet.EntityFrameworkCore/ToggleNet.EntityFrameworkCore.csproj -c Release -o ./nupkgs /p:Version=${{ steps.ver.outputs.version }} /p:IncludeSymbols=true /p:SymbolPackageFormat=snupkg /p:ContinuousIntegrationBuild=true
          dotnet pack src/ToggleNet.Dashboard/ToggleNet.Dashboard.csproj -c Release -o ./nupkgs /p:Version=${{ steps.ver.outputs.version }} /p:IncludeSymbols=true /p:SymbolPackageFormat=snupkg /p:ContinuousIntegrationBuild=true
          dotnet pack src/ToggleNet.Entitlements.Abstractions/ToggleNet.Entitlements.Abstractions.csproj -c Release -o ./nupkgs /p:Version=${{ steps.ver.outputs.version }} /p:IncludeSymbols=true /p:SymbolPackageFormat=snupkg /p:ContinuousIntegrationBuild=true
          dotnet pack src/ToggleNet.Entitlements.Stripe/ToggleNet.Entitlements.Stripe.csproj -c Release -o ./nupkgs /p:Version=${{ steps.ver.outputs.version }} /p:IncludeSymbols=true /p:SymbolPackageFormat=snupkg /p:ContinuousIntegrationBuild=true
          dotnet pack src/ToggleNet.Entitlements.Paddle/ToggleNet.Entitlements.Paddle.csproj -c Release -o ./nupkgs /p:Version=${{ steps.ver.outputs.version }} /p:IncludeSymbols=true /p:SymbolPackageFormat=snupkg /p:ContinuousIntegrationBuild=true

      - name: Publish to GitHub Packages
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for pkg in ./nupkgs/*.nupkg; do
            dotnet nuget push "$pkg" \
              --api-key $NUGET_AUTH_TOKEN \
              --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
              --skip-duplicate
          done
